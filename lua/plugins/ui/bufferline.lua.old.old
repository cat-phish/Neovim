return {
  'akinsho/bufferline.nvim',
  event = 'VeryLazy',
  dependencies = {
    { 'echasnovski/mini.bufremove', version = false, opts = {} },
  },
  keys = {
    { '<leader>bp', '<Cmd>BufferLineTogglePin<CR>', desc = 'Toggle Buffer Pin' },
    { '<leader>bP', '<Cmd>BufferLineGroupClose ungrouped<CR>', desc = 'Delete Non-Pinned Buffers' },
    { '<leader>bO', '<Cmd>BufferLineCloseOthers<CR>', desc = 'Delete Other Buffers' },
    { '<leader>bR', '<Cmd>BufferLineCloseRight<CR>', desc = 'Delete Buffers to the Right' },
    { '<leader>bL', '<Cmd>BufferLineCloseLeft<CR>', desc = 'Delete Buffers to the Left' },
    { '<Home>', '<cmd>BufferLineCyclePrev<cr>', desc = 'Prev Buffer' },
    { '<End>', '<cmd>BufferLineCycleNext<cr>', desc = 'Next Buffer' },
    { '[b', '<cmd>BufferLineCyclePrev<cr>', desc = 'Prev Buffer' },
    { ']b', '<cmd>BufferLineCycleNext<cr>', desc = 'Next Buffer' },
    { '<leader>b>', '<cmd>BufferLineMoveNext<cr>', desc = 'Move Buffer Right' },
    { '<leader>b<', '<cmd>BufferLineMovePrev<cr>', desc = 'Move Buffer Left' },
    { '<C->>', '<cmd>BufferLineMoveNext<cr>', desc = 'Move Buffer Right' },
    { '<C-lt>', '<cmd>BufferLineMovePrev<cr>', desc = 'Move Buffer Left' },
  },
  opts = {
    options = {
        -- stylua: ignore
        close_command = function(n) require("mini.bufremove").delete(n, false) end,
        -- stylua: ignore
        right_mouse_command = function(n) require("mini.bufremove").delete(n, false) end,

      diagnostics = false, -- Disabled to avoid session restore issues
      always_show_bufferline = true,

      offsets = {
        {
          filetype = 'neo-tree',
          text = 'Neo-tree',
          highlight = 'Directory',
          text_align = 'left',
        },
        {
          filetype = 'snacks_layout_box',
          highlight = 'Directory',
          text_align = 'left',
        },
        {
          filetype = 'fyler',
          text = 'Explorer',
          highlight = 'Directory',
          text_align = 'left',
        },
      },

      -- Custom filter to prevent special buffers from showing
      custom_filter = function(buf_number)
        local buftype = vim.bo[buf_number].buftype
        local filetype = vim.bo[buf_number].filetype

        -- Filter out fyler and other special buffers
        if filetype == 'fyler' then return false end

        -- Filter out special buffer types
        if buftype == 'terminal' or buftype == 'quickfix' then return false end

        return true
      end,
    },
  },

  config = function(_, opts)
    require('bufferline').setup(opts)

    -- Track last normal window for navigation
    _G.last_normal_win = nil
    vim.api.nvim_create_autocmd('WinEnter', {
      callback = function()
        local bt = vim.bo.buftype
        local ft = vim.bo.filetype

        -- Normal, editable file buffers only
        if bt == '' and ft ~= 'fyler' then _G.last_normal_win = vim.api.nvim_get_current_win() end
      end,
    })
  end,
}
